@model Information_System.Models.DocInfoModel
@{
    ViewBag.Title = "InformationFormat";
    Information_System.Models.AccessRightModel p = null;
    p = Session["permission"] as Information_System.Models.AccessRightModel;
}

<style>
    .fw-500 {
        font-weight: 500;
    }

    .form {
        font-size: 18px;
    }

    .bg-form {
        background-color: #ECECEC; /*#F6F6F6*/
    }

    .br-r {
        border-radius: 8px;
    }

    .br {
        /*border: solid;*/
        border-width: 1px;
        background-color: white;
    }

    .br-s {
        border: solid;
        border-width: 1px;
    }

    .div-comment {
        background-color: white;
        border-radius: 8px;
    }

    .font-name {
        font-weight: 500;
        font-size: 16px;
        color: #1F618D;
    }
</style>

<div style="background-color: white; padding: 16px;" class="mt-2">
    <h2>Information</h2>
    @if (Model.ID == null || Model.ID == "")
    {
        <p style="color: red;">No Result. Please try again!</p>
    }
    else
    {
        <div class="form">
            <div class="row" style="height: 54px;margin-right:16px; text-align: center;">
                <div class="col-lg-9"></div>
                <div class="col-lg-3 pt-2" style="font-size: 20px; border-top-left-radius: 8px; border-top-right-radius: 8px; background-color:#1F618D; color:white;">
                    @*<label for="staticEmail2">Information No:</label>*@
                    <label type="text" id="staticEmail2" class="fw-500">@Model.INFO_NO</label>
                </div>
            </div>
            @*<div class="bg-form">*@
            <div class="row bg-form" style="margin-right: 16px; margin-left: 16px;">
                <div class="col-lg-7 bg-form">
                    <div class="br br-r" style="margin:16px 0px 16px;">
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Subject: </label><label type="text" id="staticEmail2">&nbsp; @Model.DOC_SUBJECT</label></div>
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Plant/Dept: </label><label type="text" id="staticEmail2">&nbsp; @Model.PLANT_DEP</label></div>
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Reson Explain: </label><label type="text" id="staticEmail2">&nbsp;@Model.REASON_EXPLAIN</label></div>
                        <div>
                            <label for="staticEmail2" class="fw-500">&nbsp;Detail Reference: </label>
                            @if (Model.DETAIL_REF == null || Model.DETAIL_REF == "" || Model.DETAIL_REF == "-")
                            {
                                <label type="text" id="staticEmail2">&nbsp;@Model.DETAIL_REF</label>
                            }
                            else
                            {
                                <a href="@Url.Action("ReceivedRequirment","Create")/@Model.REQUEST_ID" target="_blank" id="staticEmail2">@Model.DETAIL_REF</a>
                            }
                        </div>
                    </div>
                </div>
                <div class="col-lg-5 bg-form">
                    <div class="br br-r" style="margin:16px 0px 16px;">
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Issue date: </label><label type="text" id="staticEmail2">&nbsp; @Model.ISSUE_DATE.ToShortDateString()</label></div>
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Prepare by: </label><label type="text" id="staticEmail2">&nbsp;@Model.ISSUE_NAME</label></div>
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Check by: </label><label type="text" id="staticEmail2">&nbsp; @Model.REVIEW_NAME</label></div>
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Approved by: </label><label type="text" id="staticEmail2">&nbsp; @Model.APPROVE_NAME</label></div>
                    </div>
                </div>
            </div>

            <div class="row bg-form" style="margin:0px 16px 0px 16px;">
                <div class="br br-r" style="width: 100%; margin:0px 16px 16px 16px;">
                    <div class="br br-s br-r bg-form" style="width: 98%; margin:16px 16px 16px 16px; height: 180px;">
                        &nbsp;<u>Document Detail:</u>
                        <p class="ml-1 mr-1">@Model.DOC_DETAIL</p>
                    </div>

                    <div class="br br-s br-r bg-form" style="width: 98%; margin:16px 16px 16px 16px;">
                        &nbsp;<u>Picture referance:</u>
                        <div class="row mt-1 mb-3">
                            <div class="col-lg-6" style="text-align: center;">
                                @if (Model.txt_PIC_REF_1 != null && Model.txt_PIC_REF_1 != "")
                                {
                                    <img src="~/Temp_File/@Model.txt_PIC_REF_1" style="border:solid;border-width: 0.5px; height: 350px;" />
                                }
                            </div>
                            <div class="col-lg-6" style="text-align: center;">
                                @if (Model.txt_PIC_REF_2 != null && Model.txt_PIC_REF_2 != "")
                                {
                                    <img src="~/Temp_File/@Model.txt_PIC_REF_2" style="border:solid;border-width: 0.5px; height: 350px;" />
                                }
                            </div>
                        </div>
                    </div>

                    <div class="br br-s br-r bg-form" style="width: 98%; margin:16px 16px 16px 16px;">
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Effective: </label><label type="text" id="staticEmail2">&nbsp; @Model.EFFECTIVE</label></div>
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Add order no: </label><label type="text" id="staticEmail2">&nbsp; @Model.ADD_ORDER_NO</label></div>
                        <div><label for="staticEmail2" class="fw-500">&nbsp;Relation system: </label><label type="text" id="staticEmail2">&nbsp; @Model.RELATION_ID (@Model.RELATION_TEXT)</label></div>
                    </div>

                    <div class="br br-s br-r bg-form" style="width: 98%; margin:16px 16px 16px 16px;">
                        <div class="row">
                            <div class="col-lg-2 fw-500" style="text-align:center; margin-top: 38px;">Attached document</div>
                            <div>
                                <div><label for="staticEmail2">&nbsp;Purchase request form:</label><a href="~/Temp_File/@Model.txt_ATT_DOC_PURCHASE" target="_blank" id="staticEmail2">&nbsp; @Model.txt_ATT_DOC_PURCHASE</a></div>
                                <div><label for="staticEmail2">&nbsp;Important notice form:</label><a href="~/Temp_File/@Model.txt_DOC_IMPORTANT" target="_blank" id="staticEmail2">&nbsp; @Model.txt_DOC_IMPORTANT</a></div>
                                <div><label for="staticEmail2">&nbsp;Requirement document: </label><a href="~/Temp_File/@Model.txt_ATT_DOC_REQUIRE" target="_blank" id="staticEmail2">&nbsp; @Model.txt_ATT_DOC_REQUIRE</a></div>
                                @foreach (var item in Model.txt_ATT_DOC_OTHER)
                                {
                                    <div><label for="staticEmail2">&nbsp;Other: </label><a href="~/Temp_File/@item" target="_blank" id="staticEmail2">&nbsp; @item</a></div>
                                }

                            </div>
                        </div>
                    </div>

                    <div class="br br-s br-r bg-form" style="width: 98%; margin:16px 16px 16px 16px;">
                        <p class="fw-500 ml-2 mt-2">Consideration & confirmation</p>
                        <div class="col-lg-9 table-responsive">
                            <table class="tb-radius table table-hover table-striped">
                                <thead style="background-color: #1F618D; color: white;">
                                    <tr>
                                        @*<th>Position</th>*@
                                        <th>Department</th>
                                        <th>Name</th>
                                        @*<th>Signature</th>*@
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Comment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var l in Model.TE_APPROVE_LIST)
                                    {
                                        <tr>
                                            <td>@l.APPROVE_DEPT</td>
                                            <td>@l.APPROVE_NAME</td>
                                            @if (l.APPROVE_DATE == null)
                                            {
                                                <td>-</td>
                                            }
                                            else
                                            {
                                                <td>@l.APPROVE_DATE</td>
                                            }
                                            <td>@l.STATUS</td>
                                            <td>@l.COMMENT</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                    </div>

                </div>
            </div>


            @if (Model.RevDoc.Count > 0)
            {
                <div id="divRef" class="row mb-4 mt-4" style="margin:0px 16px 0px 16px; background-color: #ECECEC;">
                    <div class="col-lg-12 pl-4 pr-4 pt-3">
                        <p><b>Related documents</b></p>
                    </div>
                    <div class="col-lg-12 pl-4 pb-2">
                        @for (var i = 0; i < Model.RevDoc.Count; i++)
                        {
                            <p><a href="~/Approve/InformationFormat/@Model.RevDoc[i].INFO_ID" target="_blank">@Model.RevDoc[i].INFO_NAME [@Model.RevDoc[i].STATUS]</a></p>
                        }
                    </div>
                </div>
            }

            @if (p.IS_TE || p.IS_IT)
            {
                <div class="row mb-4 mt-4" style="margin:0px 16px 0px 16px; background-color: #ECECEC;">
                    <div class="col-lg-12 pl-4 pr-4 pt-3 pb-3">
                        <p><b>Comment</b></p>
                        <div id="divComment">
                        </div>
                    </div>

                    @if (Model.STATUS_ALL == "IN-PROGRESS")
                    {
                        <div class="col-lg-12 pl-4 pr-4 pb-3">
                            <div class="row">
                                <div class="col-7">
                                    <textarea class="form-control mr-2 col-lg-12" id="txtComment" rows="3" placeholder="Enter text here..."></textarea>
                                </div>
                                <div class="col-3">
                                    <input type="file" id="fileUpload" multiple />
                                    <button type="button" class="btn bg-primary mt-2" style="background-color: #1F618D; color: white;" data-toggle="modal" data-target="#saveModel">Send Message</button>
                                    <small id="err" style="color: red; display: none;"></small>
                                </div>
                            </div>
                        </div>
                    }
                </div>

            }

            @*</div>*@

        </div>

    }

</div>

<div class="modal fade" id="saveModel" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Comment and Send Email</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">Do you want to comment and send email?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="setComment();" data-dismiss="modal">Yes</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loadingModel" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog" style="top: 30%;" role="document">
        <div>
            <div style="align-items: center;">
                <div class="loader-cycle" style="margin:0 auto;"></div>
                <h4 class="mt-3" style="color:#3498db; text-align:center; text-shadow: 1px 1px #000000;">In-Progress</h4>
            </div>
        </div>
    </div>
</div>

<script>

    window.onload = function () {
        getComment();
    }

    function setComment() {
        if ($('#txtComment').val() == "") {
            console.log('test01');
            document.getElementById("err").innerText = "Please enter the text!";
            document.getElementById("err").style.display = "block";
        }
        else
        {
            document.getElementById("err").style.display = "none";
            $('#loadingModel').modal('show');
            var fileUpload = $("#fileUpload").get(0);
            var files = fileUpload.files;
            var data = new FormData();
            data.append("IS_ID", '@Model.ID');
            data.append("IS_NO", '@Model.INFO_NO');
            data.append("COMMENT", $('#txtComment').val());
            for (var i = 0; i < files.length; i++) {
                data.append(files[i].name, files[i]);
            }

            $.ajax({
                type: "post",
                data: data,
                contentType: false,
                processData: false,
                cache: false,
                url: "@Url.Action("setComment", "Approve")",
                success: function (data) {
                    if (data == "True") {
                        getComment()
                        $('#loadingModel').modal('hide');
                        document.getElementById("txtComment").value = "";
                    } else {
                        $('#loadingModel').modal('hide');
                        document.getElementById("err").innerText = "Error! Please try again.";
                        document.getElementById("err").style.display = "block";
                    }
                }
            });
        }

    }

    function getComment() {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                $('#divComment').empty();
                var list = JSON.parse(xhr.responseText);
                var html = "";
                for (var i = 0; i < list.length; i++) {
                    html += " <div class='col-lg-7 mt-2 div-comment'> <div class='font-name pt-2'>" + list[i].CREATED_BY + " [ " + list[i].DEPT + "]</div>";
                    html += " <small>" + list[i].CREATED_DATE + "</small>";
                    html += " <div class='mt-1 pb-2'>" + list[i].COMMENT + "</div>";
                    var files = list[i].FILES;
                    for (var n=0; n < files.length; n++)
                    {
                        var filetype = files[n].slice((files[n].lastIndexOf(".") - 1 >>> 0) + 2);
                        if (filetype == 'png' || filetype == 'PNG' || filetype == 'JPG' || filetype == 'jpg') {
                            html += "<div><img class='mb-3 mt-1' style='max-width: 600px;' src='http://10.145.163.10/cloud/IS/IS_COMMENT/" + files[n] + "' /></div>"
                        }
                        else {
                            html += "<div><a target='_blank' href='http://10.145.163.10/cloud/IS/IS_COMMENT/" + files[n] + "'>" + files[n] + "</a></div>";
                        }

                    }
                    html += " </div> ";
                }
                $('#divComment').append(html)
            }
        }
        var url = '@Url.Action("getComment", "Approve")/@Model.ID';
        xhr.open("GET", url, true);
        xhr.send(null);
    }

</script>
